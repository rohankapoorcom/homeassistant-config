###############################################################################
#  @author       :  Rohan Kapoor
#  @date         :  07/23/2021
#  @package      :  Garage
#  @description  :  Automations in the Garage
###############################################################################
---
homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################
    package.node_anchors:
      customize: &customize
        package: 'garage'

################################################
## Light
################################################
light:
  - platform: switch
    name: Garage Lights
    entity_id: switch.garage_lights

################################################
## Binary Sensor
################################################
binary_sensor:
  - platform: group
    name: Garage Motion
    unique_id: e0fcd27b-7ca9-42c3-815e-63d15f0795ed
    device_class: motion
    entities:
      - binary_sensor.garage_lights_motion
      - binary_sensor.garage_multisensor_motion

################################################
## Template Sensor
################################################
template:
  - trigger:
      - platform: state
        entity_id:
          - cover.garage_door
        not_to:
          - unavailable
          - unknown
        not_from:
          - unavailable
          - unknown
    sensor:
      - unique_id: 8e28f5a9-4f22-4763-a7a5-1304ee20d8a4
        name: Garage Door Change History
        state: "OK"
        attributes:
          changes: >
            {% set current = this.attributes.get('changes', {}) %}
            {% set new =
              { trigger.entity_id:
                {
                  'datetime': trigger.to_state.last_changed.isoformat(),
                  'from': trigger.from_state.state,
                  'to': trigger.to_state.state
                }
              }
            %}
            {{ dict(current, **new) }}

automation:
  - id: 8cbaf941-3de6-482e-9226-fbe103e7c84e
    alias: Control the Garage Lights
    mode: restart
    max_exceeded: silent
    triggers:
      - trigger: homeassistant
        event: start
      - trigger: event
        event_type: automation_reloaded
      - trigger: state
        entity_id: binary_sensor.garage_motion
        from: 'off'
        to: 'on'
      - trigger: state
        entity_id: cover.garage_door
        from: 'closed'
        to: 'opening'
    actions:
      - choose:
          - alias: If there is motion, the garage door is opening or open, then turn on the lights.
            conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: binary_sensor.garage_motion
                    state: 'on'
                  - condition: state
                    entity_id: cover.garage_door
                    state: 'opening'
                  - condition: state
                    entity_id: cover.garage_door
                    state: 'open'
            sequence:
              - action: light.turn_on
                target:
                  entity_id:
                    - light.garage_lights
                    - light.garage_door_light
              - action: switch.turn_on
                target:
                  entity_id:
                    - switch.garage_tablet_screen
              - wait_for_trigger:
                  - trigger: template
                    value_template: >
                      {{ is_state('cover.garage_door', 'closed')
                      and is_state('binary_sensor.garage_motion', 'off') }}
                continue_on_timeout: false
              - delay:
                  minutes: 10
              - action: light.turn_off
                target:
                  entity_id:
                    - light.garage_lights
                    - light.garage_door_light
              - action: switch.turn_off
                target:
                  entity_id:
                    - switch.garage_tablet_screen
        default:
          - action: light.turn_off
            target:
              entity_id:
                - light.garage_lights
                - light.garage_door_light
          - action: switch.turn_off
            target:
              entity_id:
                - switch.garage_tablet_screen

  - id: c0f6513b-6fac-4e3b-bf92-0399e75e67f5
    alias: Control the Garage Entry Lights
    mode: restart
    max_exceeded: silent
    triggers:
      - trigger: homeassistant
        event: start
      - trigger: event
        event_type: automation_reloaded
      - trigger: state
        entity_id: binary_sensor.garage_entry_motion_sensor
        from: 'off'
        to: 'on'
      - trigger: state
        entity_id: cover.garage_door
        from: 'closed'
        to: 'opening'
    actions:
      - choose:
          - alias: If it's dark and (there is motion or the garage door is opening or open), then turn on the lights.
            conditions:
              - condition: and
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: binary_sensor.garage_entry_motion_sensor
                        state: 'on'
                      - condition: state
                        entity_id: cover.garage_door
                        state: 'opening'
                      - condition: state
                        entity_id: cover.garage_door
                        state: 'open'
                  - condition: numeric_state
                    entity_id: sensor.garage_entry_motion_sensor_illuminance
                    below: 100

            sequence:
              - action: light.turn_on
                target:
                  entity_id: light.garage_entry_lights
              - wait_for_trigger:
                  - trigger: template
                    value_template: >
                      {{ is_state('cover.garage_door', 'closed')
                      and is_state('binary_sensor.garage_entry_motion_sensor', 'off') }}
                continue_on_timeout: false
              - delay:
                  minutes: 1
              - action: light.turn_off
                target:
                  entity_id: light.garage_entry_lights
        default:
          - action: light.turn_off
            entity_id: light.garage_entry_lights

  - id: '1649035604702'
    alias: Garage Scene Controller Scene Controls
    description: 'Utilizes a blueprint to control scenes in the garage.'
    use_blueprint:
      path: IOT_Ninja/zooz-zen30-double-switch-automation-helper.yaml
      input:
        zooz_zen30: 91a73ad6fd7d0c4885fedd856cf2701d
        relay_1x:
          - action: script.turn_off_lights_in_areas
            data:
              areas:
                - hallway_bathroom
                - living_room
                - kitchen
                - dining_room
                - master_bathroom
                - master_bedroom
                - office
                - downstairs_bathroom
                - downstairs_hallway
                - guest_room
                - gym
        relay_2x:
          - action: script.turn_off_lights_in_areas
            data:
              areas:
                - hallway
                - hallway_bathroom
                - living_room
                - kitchen
                - dining_room
                - master_bathroom
                - master_bedroom
                - office
                - downstairs_bathroom
                - downstairs_hallway
                - guest_room
                - gym

  - id: 4c9eaa93-7d04-4e3c-94b1-bfda6e3a89b9
    alias: Send Garage Vacuum Home When Garage Door Opens
    description: >-
      Sends the garage vacuum back to the dock when the garage door
      starts opening and the garage vacuum is not currently docked.
    mode: single
    triggers:
      - trigger: state
        entity_id: cover.garage_door
        from: 'closed'
        to: 'opening'
    conditions:
      - alias: "Safety check: Ensure garage vacuum is away from dock and available"
        condition: template
        value_template: >-
          {{ states('vacuum.valetudo_garage_vacuum')
          not in ['docked', 'unavailable'] }}
    actions:
      - action: vacuum.return_to_base
        target:
          entity_id: vacuum.valetudo_garage_vacuum

  - id: 6802a847-eb44-4698-ab4e-94af83d4f8c8
    alias: Daily Garage Cleaning
    description: >-
      Cleans the garage every night at 11:00 PM using the garage vacuum
      if the garage door has opened at least once in the last 24 hours.
      Ensures both the garage door cover and binary sensor are closed before
      starting the cleaning run.
    mode: single
    triggers:
      - trigger: time
        at: '23:00:00'
    conditions:
      - alias: "Verify garage door opened at least once in last 24 hours"
        condition: template
        value_template: >-
          {% set changes = state_attr('sensor.garage_door_change_history', 'changes') %}
          {% if changes is none or 'cover.garage_door' not in changes %}
            false
          {% else %}
            {% set last_change = changes['cover.garage_door'].datetime | as_datetime %}
            {{ (as_timestamp(now()) - as_timestamp(last_change)) < 86400 }}
          {% endif %}
      - alias: "Verify garage door (for cars) and garage door (for humans) are both closed before cleaning"
        condition: and
        conditions:
          - condition: state
            entity_id: cover.garage_door
            state: 'closed'
          - condition: state
            entity_id: binary_sensor.garage_door_lock_window_door_is_open
            state: 'off'
    actions:
      - action: select.select_option
        target:
          entity_id: select.valetudo_garage_vacuum_mode
        data:
          option: vacuum
      - action: select.select_option
        target:
          entity_id: select.valetudo_garage_vacuum_fan
        data:
          option: max
      - action: vacuum.start
        target:
          entity_id: vacuum.valetudo_garage_vacuum
